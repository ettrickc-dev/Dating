<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>IndependentPlaymates ‚Äî Free Dating ¬∑ Live Chat ¬∑ Local Ads</title>
<link rel="canonical" href="https://independentplaymates.com/"/>
<meta name="description" content="Free, simple dating: sign in, make a profile, swipe, match, and chat in real time. 18+, consent-first. Run your own house ad (admin), approve paid ads by state."/>
<meta property="og:title" content="IndependentPlaymates ‚Äî Free Dating ¬∑ Live Chat ¬∑ Local Ads"/>
<meta property="og:description" content="Sign in, swipe, match, and chat. Free and consent-first. Local ads by state."/>
<meta property="og:type" content="website"/>
<meta property="og:url" content="https://independentplaymates.com/"/>
<meta name="theme-color" content="#7c3aed"/>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='64' width='64'%3E%3Crect width='100%25' height='100%25' rx='12' ry='12' fill='%237c3aed'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-size='40' font-family='Arial' fill='white'%3EIP%3C/text%3E%3C/svg%3E">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
:root{--ink:#0f172a;--muted:#475569;--line:#e2e8f0;--primary:#7c3aed;--accent:#10b981;--rose:#f43f5e;--amber:#f59e0b}
html,body{background:#fff;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.card{border:1px solid var(--line);border-radius:18px;background:#fff}
.btn{padding:.9rem 1.1rem;border-radius:16px;display:inline-flex;gap:.6rem;align-items:center;justify-content:center;font-size:1rem}
.btn-ghost{border:2px solid var(--line);background:#fff}
.btn-primary{background:var(--primary);color:#fff;box-shadow:0 8px 22px rgba(124,58,237,.16)}
.btn-accent{background:var(--accent);color:#fff}
.btn-rose{background:var(--rose);color:#fff}
.badge{font-size:.9rem;padding:.25rem .6rem;border-radius:.6rem;background:#ecfeff;color:#155e75;border:1px solid #a5f3fc}
.section{padding:28px}
.small{font-size:.95rem;color:#475569}
.hero{background:radial-gradient(1200px 500px at 20% -10%, rgba(124,58,237,.08), transparent),radial-gradient(800px 400px at 110% -20%, rgba(244,63,94,.08), transparent)}
.vibe{border-radius:18px;overflow:hidden;position:relative;min-height:180px;display:flex;align-items:flex-end}
.vibe .shade{position:absolute;inset:0;background:linear-gradient(0deg,rgba(0,0,0,.45),transparent 60%)}
.vibe .txt{position:relative;color:#fff;padding:16px}
.vibe-1{background:linear-gradient(135deg,#7c3aed,#3b82f6)}
.vibe-2{background:linear-gradient(135deg,#ef4444,#f59e0b)}
.vibe-3{background:linear-gradient(135deg,#10b981,#06b6d4)}
.vibe-4{background:linear-gradient(135deg,#f43f5e,#a855f7)}
.grid-auto{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:16px}
.avatar{width:100%;height:230px;border-radius:16px;object-fit:cover;border:1px solid var(--line);background:#eee}
.chip{display:inline-block;border:2px solid var(--line);border-radius:999px;padding:.35rem .75rem;margin:.15rem;font-size:.9rem}
.swipe{position:relative;height:560px}
.swipe-card{width:100%;max-width:420px;aspect-ratio:3/4;border-radius:22px;overflow:hidden;position:absolute;left:50%;transform:translateX(-50%);box-shadow:0 12px 30px rgba(2,6,23,.12)}
.swipe-photo{width:100%;height:62%;object-fit:cover;background:#000}
.swipe-info{padding:14px 16px}
.hide{display:none!important}
.room.active{background:#111;color:#fff;border-color:#111}
input,select,textarea{width:100%;border:2px solid var(--line);border-radius:14px;padding:.8rem .9rem;font-size:1rem}
label{font-weight:700}
kbd{background:#111;color:#fff;border-radius:8px;padding:.2rem .45rem;font-size:.85rem}
.help-bubble{background:#fff3c4;border:2px dashed #f59e0b;border-radius:14px;padding:.6rem .8rem}
.notice{background:#ecfeff;border:2px solid #a5f3fc;border-radius:14px;padding:.6rem .8rem}
.ad-card img{max-height:280px;object-fit:cover}
.sticky-cta{position:sticky;bottom:10px;z-index:30;display:flex;gap:10px;flex-wrap:wrap}
</style>
</head>
<body class="antialiased">

<header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="text-2xl font-extrabold">IndependentPlaymates</div>
      <span class="badge">Free ¬∑ 18+ ¬∑ Consent-First ¬∑ Realtime</span>
    </div>
    <nav class="hidden md:flex gap-4 text-sm">
      <a href="#ads" class="hover:underline">Home</a>
      <a href="#rooms" class="hover:underline">Rooms</a>
      <a href="#trending" class="hover:underline">Discover</a>
      <a href="#match" class="hover:underline">Swipe</a>
      <a href="#inbox" class="hover:underline">Messages</a>
      <a href="#profile" class="hover:underline">My Profile</a>
      <a href="#support" class="hover:underline">Donate</a>
      <a href="#ad-self" class="hover:underline">Buy Ads</a>
      <a href="#admin" class="hover:underline">Admin</a>
    </nav>
  </div>
</header>

<section class="max-w-6xl mx-auto px-4 mt-4">
  <div class="card p-4 flex flex-wrap items-center justify-between gap-3">
    <div class="flex-1">
      <div id="authStatus" class="small">You‚Äôre not signed in. Type your email and tap the purple button.</div>
    </div>
    <div class="flex items-center gap-2">
      <input id="authEmail" type="email" placeholder="you@email.com" aria-label="Email"/>
      <button id="authGo" class="btn btn-primary">Send magic link</button>
      <button id="authOut" class="btn btn-ghost">Sign out</button>
    </div>
  </div>
</section>

<section class="hero">
  <div class="max-w-6xl mx-auto px-4 section grid lg:grid-cols-3 gap-6 items-center">
    <div class="lg:col-span-2">
      <h1 class="text-5xl font-extrabold leading-tight">Meet kind people. Match. Chat. Free.</h1>
      <p class="mt-3 small">1) Sign in ‚Ä¢ 2) Make your profile ‚Ä¢ 3) Pick a room ‚Ä¢ 4) Swipe & chat after you match.</p>
      <div class="mt-5 flex flex-wrap gap-3 sticky-cta">
        <a href="#profile" class="btn btn-primary">Step 1 ‚Äî Make Profile</a>
        <a href="#rooms" class="btn btn-rose">Step 2 ‚Äî Pick a Room</a>
        <a href="#trending" class="btn btn-accent">Step 3 ‚Äî Discover</a>
      </div>
      <p class="small mt-3 help-bubble"><b>Tip:</b> On Swipe: <kbd>‚Üê</kbd> pass, <kbd>‚Üí</kbd> like, <kbd>‚Üë</kbd> superlike. Or drag cards.</p>
      <p class="small mt-2 notice"><b>Safety & Policy:</b> 18+ only. No explicit content. No escorting/paid arrangements. Public first meet, tell a friend.</p>
    </div>
    <div class="grid gap-3">
      <div class="vibe vibe-1"><div class="shade"></div><div class="txt"><div class="text-xl font-bold">Playful banter</div><div class="small">‚ÄúTwo truths & a dare.‚Äù</div></div></div>
      <div class="vibe vibe-2"><div class="shade"></div><div class="txt"><div class="text-xl font-bold">Slow-burn romance</div><div class="small">‚ÄúPerfect cozy day?‚Äù</div></div></div>
      <div class="vibe vibe-3"><div class="shade"></div><div class="txt"><div class="text-xl font-bold">Adventure crush</div><div class="small">‚ÄúSunrise hike?‚Äù</div></div></div>
      <div class="vibe vibe-4"><div class="shade"></div><div class="txt"><div class="text-xl font-bold">Art & ambiance</div><div class="small">‚ÄúGallery + gelato?‚Äù</div></div></div>
    </div>
  </div>
</section>

<!-- =================== ADS HOMEPAGE =================== -->
<section id="ads" class="max-w-6xl mx-auto px-4 section card">
  <div class="flex items-center justify-between">
    <h2 class="text-3xl font-bold">Local Promos</h2>
    <div class="small">
      <label for="statePick"><b>Your state:</b></label>
      <select id="statePick" aria-label="Choose your state"></select>
    </div>
  </div>
  <p class="small mt-1">Ads show for your chosen state. Admin can run one free ‚Äúhouse ad.‚Äù Advertisers can buy state-targeted slots.</p>
  <div id="adsGrid" class="grid-auto mt-3"></div>
</section>

<!-- ROOMS -->
<section id="rooms" class="max-w-6xl mx-auto px-4 section card">
  <div class="flex items-center justify-between">
    <h2 class="text-3xl font-bold">Rooms (Tap to Filter)</h2>
    <span id="roomHint" class="small text-slate-700">Pick a room. We filter Discover & Swipe.</span>
  </div>
  <div id="roomsBar" class="mt-3 flex flex-wrap gap-2">
    <button class="chip room active" data-room="all">All</button>
    <button class="chip room" data-room="coffee">Coffee lovers ‚òï</button>
    <button class="chip room" data-room="live">Live music üé∏</button>
    <button class="chip room" data-room="hike">Hikers ü•æ</button>
    <button class="chip room" data-room="books">Bookworms üìö</button>
    <button class="chip room" data-room="film">Film buffs üé¨</button>
    <button class="chip room" data-room="art">Artsy üñºÔ∏è</button>
    <button class="chip room" data-room="yoga">Yogis üßò</button>
    <button class="chip room" data-room="run">Runners üèÉ</button>
    <button class="chip room" data-room="food">Foodies üçú</button>
    <button class="chip room" data-room="game">Gamers üéÆ</button>
    <button class="chip room" data-room="nsa">NSA (Adults Only) üî•</button>
  </div>
  <p class="small mt-2 notice"><b>NSA Room rules:</b> 18+ only, respect & consent, no nudity/explicit content, no escorting or paid arrangements.</p>
</section>

<!-- DISCOVER -->
<section id="trending" class="max-w-6xl mx-auto px-4 section card">
  <div class="flex items-center justify-between">
    <h2 class="text-3xl font-bold">Discover</h2>
    <a href="#match" class="btn btn-rose">Go to Swipe</a>
  </div>
  <p class="small mt-1">Live profiles from Supabase.</p>
  <div id="grid" class="grid-auto mt-3"></div>
</section>

<!-- SWIPE -->
<section id="match" class="max-w-6xl mx-auto px-4 section card">
  <div class="grid lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2">
      <h2 class="text-3xl font-bold">Swipe</h2>
      <p class="small">Drag or use keys: <kbd>‚Üí</kbd> Like, <kbd>‚Üê</kbd> Pass, <kbd>‚Üë</kbd> Superlike.</p>
      <div class="swipe mt-3" id="stack"></div>
      <div class="mt-[580px] flex items-center justify-center gap-3">
        <button id="btnPass" class="btn btn-ghost">üôÖ Pass</button>
        <button id="btnLike" class="btn btn-primary">üëç Like</button>
        <button id="btnSuper" class="btn btn-accent">‚≠ê Superlike</button>
        <button id="btnOpen" class="btn btn-ghost">üëÅ View</button>
      </div>
    </div>
    <div class="card p-4">
      <h3 class="font-bold text-2xl">Filters</h3>
      <div class="help-bubble mt-1 small">Pick simple sliders. Tap <b>Apply</b>.</div>
      <label class="mt-3 block small">Age Range</label>
      <div class="grid grid-cols-2 gap-2">
        <input id="ageMin" type="number" min="18" max="100" value="22"/>
        <input id="ageMax" type="number" min="18" max="100" value="45"/>
      </div>
      <label class="mt-3 block small">Max Distance (miles)</label>
      <input id="distance" type="number" min="1" max="500" value="50"/>
      <label class="mt-3 block small">Goals</label>
      <select id="goalsFilter">
        <option value="">Any</option>
        <option>Long-term relationship</option>
        <option>Monogamous dating</option>
        <option>Casual dating</option>
        <option>Open to exploring</option>
        <option>Friendship first</option>
      </select>
      <div class="mt-3 flex gap-2">
        <button id="applyFilters" class="btn btn-ghost">Apply</button>
        <button id="resetDeck" class="btn btn-ghost">Reset</button>
      </div>
    </div>
  </div>
</section>

<!-- INBOX -->
<section id="inbox" class="max-w-6xl mx-auto px-4 section card">
  <div class="grid lg:grid-cols-3 gap-6">
    <div class="card p-4">
      <h3 class="text-2xl font-bold">Matches</h3>
      <div id="matchList" class="mt-3" style="max-height:340px;overflow:auto"></div>
    </div>
    <div class="lg:col-span-2 card p-4">
      <div class="flex items-center justify-between">
        <h3 class="text-2xl font-bold">Chat</h3>
      </div>
      <div id="chatHeader" class="mt-2 small"></div>
      <div id="chatBox" class="mt-3 h-[380px] border border-slate-200 rounded-xl p-3" style="overflow:auto"></div>
      <div class="mt-3 flex gap-2">
        <input id="chatInput" placeholder="Type a nice message‚Ä¶" aria-label="Type message"/>
        <button id="sendMsg" class="btn btn-primary">Send</button>
      </div>
    </div>
  </div>
</section>

<!-- PROFILE -->
<section id="profile" class="max-w-6xl mx-auto px-4 section card">
  <h2 class="text-3xl font-bold">My Profile</h2>
  <p class="small">Fill this out and press <b>Save Profile</b>. Add photos (up to 6).</p>
  <div class="grid md:grid-cols-2 gap-4 mt-3">
    <div><label>Display Name</label><input id="meName" placeholder="e.g., Alex"/></div>
    <div><label>City</label><input id="meCity" placeholder="e.g., Brooklyn"/></div>
    <div><label>Age</label><input id="meAge" type="number" min="18" max="100"/></div>
    <div><label>Pronouns</label><input id="mePronouns" placeholder="she/her, he/him, they/them"/></div>
    <div class="md:col-span-2">
      <label>Relationship Goals</label>
      <select id="meGoals">
        <option value="">Select one‚Ä¶</option>
        <option>Long-term relationship</option>
        <option>Monogamous dating</option>
        <option>Casual dating</option>
        <option>Open to exploring</option>
        <option>Friendship first</option>
      </select>
    </div>
    <div class="md:col-span-2"><label>Interests (comma separated)</label><input id="meInterests" placeholder="hiking, coffee, books"/></div>
    <div class="md:col-span-2"><label>About Me</label><textarea id="meBio" rows="3" placeholder="Say something kind and simple."></textarea></div>
    <div class="md:col-span-2">
      <label>Photos (up to 6)</label>
      <input id="mePhotos" type="file" accept="image/*" multiple/>
      <div id="mePhotoGrid" class="grid grid-cols-3 gap-2 mt-2"></div>
    </div>
  </div>
  <div class="mt-4 flex flex-wrap gap-2">
    <button id="saveMe" class="btn btn-primary">Save Profile</button>
  </div>
  <p class="small mt-2 notice">Uploading uses free Supabase Storage. Keep photos friendly. No explicit content.</p>
</section>

<!-- Donate -->
<section id="support" class="max-w-6xl mx-auto px-4 section card">
  <h2 class="text-3xl font-bold">Support This Project</h2>
  <p class="small">It‚Äôs free to use. If you like it, you can donate‚Äîthank you! ‚ù§Ô∏è</p>
  <div class="mt-3 flex gap-3">
    <a class="btn btn-primary" href="https://www.paypal.com/donate/?hosted_button_id=NYAEX2BAXQ6ZJ" target="_blank" rel="noopener">Donate</a>
  </div>
</section>

<!-- BUY ADS (Self-serve) -->
<section id="ad-self" class="max-w-6xl mx-auto px-4 section card">
  <h2 class="text-3xl font-bold">Buy an Ad</h2>
  <p class="small">Your ad shows on our homepage to people in the state(s) you choose. You‚Äôll click <b>Pay Now</b>, then submit your ad for fast approval.</p>

  <div class="grid md:grid-cols-2 gap-3 mt-3">
    <div><label>Ad Title</label><input id="buyTitle" placeholder="e.g., Fast Legal Templates"/></div>
    <div><label>Link (URL)</label><input id="buyLink" placeholder="https://example.com"/></div>
    <div><label>Image URL</label><input id="buyImg" placeholder="https://picsum.photos/800"/></div>

    <div>
      <label>States (choose one or more)</label>
      <div id="buyStatesWrap" class="grid grid-cols-3 gap-2 mt-1"></div>
    </div>

    <div><label>Payment Link (Stripe/PayPal)</label><input id="buyPay" placeholder="https://buy.stripe.com/..."/></div>
    <div><label>Dates</label>
      <div class="grid grid-cols-2 gap-2">
        <input id="buyStart" type="date"/><input id="buyEnd" type="date"/>
      </div>
    </div>
  </div>

  <div class="mt-3 flex gap-2">
    <a id="buyPayNow" class="btn btn-rose" target="_blank" rel="noopener">Pay Now</a>
    <button id="buySubmit" class="btn btn-primary">Submit Ad (Review)</button>
    <button id="buyMyFree" class="btn btn-ghost">Post House Ad (Owner only)</button>
  </div>
  <p class="small mt-2 notice">After payment, we approve fast. Admin can post one free ‚Äúhouse ad.‚Äù</p>
</section>

<!-- ADMIN (Approve Ads) -->
<section id="admin" class="max-w-6xl mx-auto px-4 section card" style="display:none">
  <h2 class="text-3xl font-bold">Admin</h2>
  <p class="small">Visible only for admins.</p>
  <div class="grid md:grid-cols-2 gap-3">
    <div class="card p-3">
      <h3 class="font-bold text-xl">Pending Ads</h3>
      <div id="adminPending" class="mt-2" style="max-height:380px;overflow:auto"></div>
    </div>
    <div class="card p-3">
      <h3 class="font-bold text-xl">Approved Ads</h3>
      <div id="adminApproved" class="mt-2" style="max-height:380px;overflow:auto"></div>
    </div>
  </div>
</section>

<!-- Profile Modal (view card) -->
<div id="profileModal" class="hide" style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center">
  <div class="card p-4" style="max-width:900px;width:96%;max-height:90vh;overflow:auto">
    <div class="flex justify-between items-center">
      <h3 id="pmName" class="text-2xl font-bold"></h3>
      <button id="pmClose" class="btn btn-ghost">‚úñ</button>
    </div>
    <div class="grid md:grid-cols-2 gap-4 mt-3">
      <div id="pmGallery" class="grid grid-cols-3 gap-2"></div>
      <div>
        <div class="small" id="pmMeta"></div>
        <div class="mt-2" id="pmInterests"></div>
        <p class="small mt-2" id="pmBio"></p>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="pmLike" class="btn btn-primary">üëç Like</button>
          <button id="pmSuper" class="btn btn-accent">‚≠ê Superlike</button>
          <button id="pmMsg" class="btn btn-ghost">üí¨ Message</button>
          <button id="pmReport" class="btn btn-ghost">Report</button>
          <button id="pmBlock" class="btn btn-ghost">Block</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== YOUR SUPABASE VALUES (from you) ====== */
const SUPABASE_URL = "https://gioiqevjzrbdnspwapcg.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdpb2lxZXZqenJiZG5zcHdhcGNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNTYyODgsImV4cCI6MjA3NzYzMjI4OH0.PFJbiVU3z_YU09ufNL8QvLiSvABSqZ5bFkG4exAE7Q0";

/* ====== Supabase client ====== */
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ====== Helpers ====== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
function escapeHTML(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
function avatarPNG(name){
  const i=(name||"Me").trim(); const init=i.split(/\s+/).map(w=>w[0]||"").join("").slice(0,2).toUpperCase();
  const hue=(init.charCodeAt(0)||65)*7%360, hue2=(hue+60)%360;
  const c=document.createElement("canvas"); c.width=500; c.height=500;
  const ctx=c.getContext("2d");
  const grd=ctx.createLinearGradient(0,0,500,500);
  grd.addColorStop(0,`hsl(${hue},70%,50%)`); grd.addColorStop(1,`hsl(${hue2},70%,50%)`);
  ctx.fillStyle=grd; ctx.fillRect(0,0,500,500);
  ctx.fillStyle="#fff"; ctx.font="bold 220px Arial, Helvetica, sans-serif";
  ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(init, 250, 270);
  return c.toDataURL("image/png");
}

/* ====== Global ====== */
let ME=null, MY_PROFILE=null, DECK=[], currentCardIds=[], activeChatId=null, MSG_SUB=null;
let IS_ADMIN=false;

/* ====== AUTH ====== */
async function refreshAuthUI(){
  const { data:{ user } } = await sb.auth.getUser();
  ME = user;
  $("#authStatus").textContent = ME ? `Signed in as ${ME.email}` : "You‚Äôre not signed in. Type your email and tap the purple button.";
  // show admin tab if admin
  if(ME){
    const { data:adm } = await sb.from('admins').select('user_id').eq('user_id', ME.id).maybeSingle();
    IS_ADMIN = !!adm;
  } else IS_ADMIN=false;
  document.querySelector('a[href="#admin"]').style.display = IS_ADMIN ? "inline-flex" : "none";
  $("#admin").style.display = IS_ADMIN ? "block":"none";
}
$("#authGo").onclick = async ()=>{
  const email = $("#authEmail").value.trim();
  if(!email) return alert("Enter your email.");
  const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: window.location.href }});
  if(error) alert(error.message); else alert("Check your email for a magic link. After you click it, come back here.");
};
$("#authOut").onclick = async ()=>{ await sb.auth.signOut(); ME=null; MY_PROFILE=null; alert("Signed out."); await refreshAuthUI(); bootstrap(); };
sb.auth.onAuthStateChange(async ()=>{ await refreshAuthUI(); bootstrap(); });

/* ====== STATES ====== */
const US_STATES = ["","AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];
function fillStatePicker(){
  const s=$("#statePick"); s.innerHTML="";
  US_STATES.forEach(st=>{
    const o=document.createElement("option"); o.value=st; o.textContent = st? st : "All states";
    s.appendChild(o);
  });
  s.value = localStorage.getItem("vibes_state") || "";
  s.onchange = ()=>{ localStorage.setItem("vibes_state", s.value); renderAds(); };
}

/* ====== PROFILES ====== */
async function loadMyProfile(){
  if(!ME) return null;
  const { data } = await sb.from('profiles').select('*').eq('id', ME.id).maybeSingle();
  return data||null;
}
async function saveMyProfileRow(row){
  if(!ME) return alert("Sign in first.");
  row.id = ME.id;
  const { error } = await sb.from('profiles').upsert(row);
  if(error) alert(error.message); else alert("Profile saved!");
}
async function uploadPhotoToBucket(file){
  if(!ME) { alert("Sign in first."); return null; }
  const safe = file.name.replace(/[^a-z0-9\.\-_]/gi,'_').toLowerCase();
  const path = `${ME.id}/${Date.now()}_${safe}`;
  const { error } = await sb.storage.from('photos').upload(path, file, { upsert:true });
  if(error){ alert(error.message); return null; }
  const { data } = sb.storage.from('photos').getPublicUrl(path);
  return data.publicUrl;
}
function splitInterests(v){ return v.split(",").map(s=>s.trim()).filter(Boolean); }
function renderMyPhotosLocal(urls){
  const g=$("#mePhotoGrid"); g.innerHTML=""; (urls||[]).forEach(src=>{ const im=document.createElement("img"); im.src=src; im.className="rounded-xl border h-32 w-full object-cover"; g.appendChild(im); });
}
$("#mePhotos").addEventListener("change", async (e)=>{
  if(!ME) { alert("Sign in first."); e.target.value=""; return; }
  const files=[...e.target.files].slice(0,6);
  const urls=[];
  for(const f of files){ const u = await uploadPhotoToBucket(f); if(u) urls.push(u); }
  const merged = Array.from(new Set([...(MY_PROFILE?.photos||[]), ...urls])).slice(0,6);
  MY_PROFILE = { ...(MY_PROFILE||{}), photos: merged };
  renderMyPhotosLocal(MY_PROFILE.photos);
});
$("#saveMe").onclick = async ()=>{
  if(!ME) return alert("Sign in first.");
  const row = {
    display_name: $("#meName").value.trim(),
    city: $("#meCity").value.trim(),
    age: Number($("#meAge").value)||null,
    pronouns: $("#mePronouns").value.trim(),
    goals: $("#meGoals").value,
    interests: splitInterests($("#meInterests").value),
    bio: $("#meBio").value.trim(),
    avatar_url: (MY_PROFILE?.avatar_url)||null,
    photos: (MY_PROFILE?.photos && MY_PROFILE.photos.length? MY_PROFILE.photos : [avatarPNG($("#meName").value||"Me")])
  };
  await saveMyProfileRow(row);
  MY_PROFILE = await loadMyProfile();
  await reloadDeck();
  fillProfileForm();
};
function fillProfileForm(){
  $("#meName").value = MY_PROFILE?.display_name || "";
  $("#meCity").value = MY_PROFILE?.city || "";
  $("#meAge").value = MY_PROFILE?.age || "";
  $("#mePronouns").value = MY_PROFILE?.pronouns || "";
  $("#meGoals").value = MY_PROFILE?.goals || "";
  $("#meInterests").value = (MY_PROFILE?.interests||[]).join(", ");
  $("#meBio").value = MY_PROFILE?.bio || "";
  renderMyPhotosLocal(MY_PROFILE?.photos||[]);
}

/* ====== ADS ====== */
async function fetchApprovedAds(){
  const { data } = await sb
    .from('ads')
    .select('id, title, link, image_url, states, is_free, priority, starts_at, ends_at, created_at')
    .eq('status','approved')
    .order('priority',{ascending:false})
    .order('created_at',{ascending:false});
  return data||[];
}
function statesFromChecks(){
  return Array.from(document.querySelectorAll('.state-check:checked')).map(i=>i.value);
}
async function submitAd({title,link,image_url,states,is_free,payment_link,starts,ends}){
  if(!ME) return alert("Sign in first.");
  const { error } = await sb.from('ads').insert({
    owner: ME.id,
    title, link, image_url,
    states: states,
    is_free: !!is_free,
    payment_link,
    starts_at: starts||null,
    ends_at: ends||null,
    status: is_free ? 'pending':'pending'
  });
  if(error) alert(error.message); else alert("Ad submitted! We'll review it soon.");
}
function renderStatesChecks(containerId){
  const el = document.getElementById(containerId);
  el.innerHTML="";
  US_STATES.slice(1).forEach(st=>{
    const w=document.createElement("label");
    w.className="flex items-center gap-2 text-sm";
    w.innerHTML=`<input type="checkbox" class="state-check" value="${st}"/> ${st}`;
    el.appendChild(w);
  });
}
$("#buySubmit").onclick = async ()=>{
  const title=$("#buyTitle").value.trim(), link=$("#buyLink").value.trim(), image=$("#buyImg").value.trim();
  const states=statesFromChecks();
  const pay=$("#buyPay").value.trim(); const starts=$("#buyStart").value||null; const ends=$("#buyEnd").value||null;
  if(!title||!link||!image) return alert("Fill title, link, and image.");
  if(!states.length) return alert("Choose at least one state.");
  await submitAd({title,link,image_url:image,states,is_free:false,payment_link:pay,starts,ends});
};
$("#buyMyFree").onclick = async ()=>{
  if(!IS_ADMIN) return alert("Admins only for house ads.");
  const title=$("#buyTitle").value.trim(), link=$("#buyLink").value.trim(), image=$("#buyImg").value.trim();
  const states=statesFromChecks();
  const starts=$("#buyStart").value||null; const ends=$("#buyEnd").value||null;
  if(!title||!link||!image) return alert("Fill title, link, and image.");
  await submitAd({title,link,image_url:image,states,is_free:true, payment_link:null,starts,ends});
};
const payNowBtn = $("#buyPayNow");
$("#buyPay").addEventListener("input", ()=>{ payNowBtn.href = $("#buyPay").value.trim() || "#"; });

function renderAdsCard(ad){
  return `<div class="card p-3 ad-card">
    <a href="${ad.link}" target="_blank" rel="noopener">
      <img src="${ad.image_url}" class="w-full rounded-xl border" alt="${escapeHTML(ad.title)}"/>
      <div class="mt-2 font-bold text-xl">${escapeHTML(ad.title)}</div>
      <div class="small text-slate-600">${ad.is_free ? "House Ad" : "Sponsored"}</div>
    </a>
  </div>`;
}
async function renderAds(){
  const grid=$("#adsGrid"); grid.innerHTML="";
  const all=await fetchApprovedAds();
  const st = $("#statePick").value || "";
  const now = Date.now();
  const filtered = all.filter(a=>{
    const inDate = (!a.starts_at || new Date(a.starts_at).getTime() <= now) &&
                   (!a.ends_at || new Date(a.ends_at).getTime() >= now);
    const inState = !st || !a.states || a.states.length===0 || a.states.includes(st);
    return inDate && inState;
  });
  if(!filtered.length){
    grid.innerHTML = `<div class="small">No sponsored ads for your state yet. Check back soon!</div>`;
    return;
  }
  filtered.forEach(ad=>{ const d=document.createElement("div"); d.innerHTML=renderAdsCard(ad); grid.appendChild(d); });
}

/* ====== ADMIN (pending/approve/reject) ====== */
async function adminList(status){
  const { data } = await sb.from('ads').select('*').eq('status',status).order('created_at',{ascending:false});
  return data||[];
}
async function adminApprove(id, paid){
  if(!IS_ADMIN) return alert("Admins only.");
  const { error } = await sb.from('ads').update({ status:'approved', paid: !!paid }).eq('id', id);
  if(error) alert(error.message); else { alert("Approved."); loadAdmin(); renderAds(); }
}
async function adminReject(id){
  if(!IS_ADMIN) return alert("Admins only.");
  const { error } = await sb.from('ads').update({ status:'rejected' }).eq('id', id);
  if(error) alert(error.message); else { alert("Rejected."); loadAdmin(); }
}
async function loadAdmin(){
  if(!IS_ADMIN){ $("#adminPending").innerHTML=""; $("#adminApproved").innerHTML=""; return; }
  const p=await adminList('pending'); const a=await adminList('approved');
  const P=$("#adminPending"), A=$("#adminApproved"); P.innerHTML=""; A.innerHTML="";
  p.forEach(x=>{
    const d=document.createElement("div"); d.className="p-2 border-b border-slate-200";
    d.innerHTML = `<div class="font-semibold">${escapeHTML(x.title)}</div>
      <div class="small">${(x.states||[]).join(", ")||"All states"} ‚Ä¢ ${x.payment_link?"Has payment link":"No payment link"} ‚Ä¢ ${x.is_free?"House ad":"Sponsored"}</div>
      <div class="mt-2 flex gap-2">
        <button class="btn btn-primary" data-approve="${x.id}">Approve</button>
        <button class="btn btn-ghost" data-approve-paid="${x.id}">Approve+Paid</button>
        <button class="btn btn-ghost" data-reject="${x.id}">Reject</button>
      </div>`;
    P.appendChild(d);
  });
  a.forEach(x=>{
    const d=document.createElement("div"); d.className="p-2 border-b border-slate-200";
    d.innerHTML = `<div class="font-semibold">${escapeHTML(x.title)}</div>
      <div class="small">${(x.states||[]).join(", ")||"All states"} ‚Ä¢ ${x.is_free?"House ad":"Sponsored"} ‚Ä¢ Paid: ${x.paid?"Yes":"No"}</div>`;
    A.appendChild(d);
  });
  P.querySelectorAll("[data-approve]").forEach(b=>b.onclick=()=>adminApprove(Number(b.dataset.approve), false));
  P.querySelectorAll("[data-approve-paid]").forEach(b=>b.onclick=()=>adminApprove(Number(b.getAttribute("data-approve-paid")), true));
  P.querySelectorAll("[data-reject]").forEach(b=>b.onclick=()=>adminReject(Number(b.dataset.reject)));
}

/* ====== DISCOVER / SWIPE / CHAT ====== */
async function fetchProfiles(limit=120){
  const { data } = await sb.from('profiles')
    .select('id, display_name, city, age, pronouns, goals, interests, bio, avatar_url, photos, created_at')
    .order('created_at', { ascending:false })
    .limit(limit);
  return data||[];
}
function mapProfileRow(p){
  return {
    id: p.id, name: p.display_name || "Someone",
    age: p.age||"", city: p.city||"", goals: p.goals||"", pronouns: p.pronouns||"",
    interests: p.interests||[], bio: p.bio||"",
    photos: (p.photos && p.photos.length ? p.photos : [p.avatar_url || avatarPNG(p.display_name||"User")]),
    distance: 1 + Math.floor(Math.random()*50)
  };
}
function getP(id){ return DECK.find(x=>x.id===id); }
async function reloadDeck(){
  const rows = await fetchProfiles();
  DECK = rows.filter(r => !ME || r.id !== ME.id).map(mapProfileRow);
  currentCardIds = filterDeck();
  renderGrid(); renderStack(); renderMatches();
}
function roomsLabel(r){ const el = document.querySelector(`#roomsBar .room[data-room="${r}"]`); return el ? el.textContent.trim() : r; }
let activeRoom="all";
const ROOM_MAP = {
  all: { interests: [], goal: "" },
  coffee: { interests: ["coffee"], goal: "Friendship first" },
  live: { interests: ["live music"], goal: "" },
  hike: { interests: ["hiking"], goal: "" },
  books: { interests: ["books"], goal: "Long-term relationship" },
  film: { interests: ["film"], goal: "" },
  art: { interests: ["art","museums"], goal: "" },
  yoga: { interests: ["yoga"], goal: "" },
  run: { interests: ["running"], goal: "" },
  food: { interests: ["cooking","food"], goal: "" },
  game: { interests: ["gaming"], goal: "" },
  nsa: { interests: [], goal: "Open to exploring" }
};
document.querySelectorAll("#roomsBar .room").forEach(btn=>btn.addEventListener("click", ()=> setRoom(btn.dataset.room)));
function setRoom(r){
  activeRoom = r;
  document.querySelectorAll("#roomsBar .room").forEach(b=>b.classList.toggle("active", b.dataset.room===r));
  document.querySelector("#roomHint").textContent = r==="all" ? "Showing everyone." : `Showing people for ‚Äú${roomsLabel(r)}‚Äù.`;
  currentCardIds = filterDeck(); renderStack(); renderGrid();
}
function filterDeck(){
  const min=Number(document.querySelector("#ageMin").value)||18,
        max=Number(document.querySelector("#ageMax").value)||100,
        dist=Number(document.querySelector("#distance").value)||50,
        gSel=document.querySelector("#goalsFilter").value;
  const room = ROOM_MAP[activeRoom] || ROOM_MAP.all;
  const wanted=(room.interests||[]).map(s=>s.toLowerCase());
  return DECK.filter(p=>{
    if(p.age<min||p.age>max) return false;
    if(p.distance>dist) return false;
    if(gSel && p.goals!==gSel) return false;
    if(wanted.length){
      const pInts=(p.interests||[]).map(s=>String(s).toLowerCase());
      const hit=wanted.some(w=>pInts.some(pi=>pi.includes(w)));
      if(!hit) return false;
    }
    if(activeRoom==="nsa" && !/open to exploring|casual/i.test(p.goals||"")) return false;
    return true;
  }).map(p=>p.id);
}
function renderGrid(){
  const g=document.querySelector("#grid"); g.innerHTML="";
  const ids = filterDeck();
  ids.map(getP).filter(Boolean).slice(0,30).forEach(p=>{
    const d=document.createElement("div"); d.className="card p-3";
    d.innerHTML=`<img src="${p.photos[0]}" class="avatar" alt="${p.name}"/><div class="mt-2 font-semibold text-xl">${p.name}, ${p.age}</div><div class="small">${p.city} ¬∑ ${p.goals}</div><div class="mt-2">${(p.interests||[]).slice(0,3).map(i=>`<span class="chip">${i}</span>`).join("")}</div><div class="mt-3 flex gap-2"><button class="btn btn-ghost" data-view="${p.id}">üëÅ View</button><button class="btn btn-primary" data-like="${p.id}">üëç Like</button></div>`;
    g.appendChild(d);
  });
  g.querySelectorAll("[data-view]").forEach(b=>b.onclick=()=>openProfile(b.getAttribute("data-view")));
  g.querySelectorAll("[data-like]").forEach(b=>b.onclick=()=>likeFlow(b.getAttribute("data-like")));
}

/* Swipe */
function renderStack(){
  const s=document.querySelector("#stack"); s.innerHTML="";
  if(!currentCardIds.length) currentCardIds=filterDeck();
  currentCardIds.slice(0,4).forEach((id,idx)=>{
    const p=getP(id);
    const card=document.createElement("div"); card.className="swipe-card card"; card.dataset.id=id;
    card.style.zIndex=String(100-idx); card.style.top=(10+idx*8)+"px";
    card.innerHTML=`<img class="swipe-photo" src="${p.photos[0]}" alt="${p.name}"/><div class="swipe-info"><div class="flex items-center justify-between"><div class="text-2xl font-bold">${p.name}, ${p.age}</div><div class="small">${p.city} ¬∑ ${p.distance} mi</div></div><div class="small">${p.pronouns||""} ¬∑ ${p.goals}</div><div class="mt-2">${(p.interests||[]).map(i=>`<span class="chip">${i}</span>`).join("")}</div><p class="small mt-2">${p.bio||""}</p></div>`;
    s.appendChild(card); enableDrag(card);
  });
}
function topId(){ return currentCardIds[0]; }
function removeTop(){ currentCardIds.shift(); renderStack(); }
function enableDrag(card){
  let sx=0,sy=0,x=0,y=0,drag=false;
  const down=e=>{drag=true; sx=(e.touches?e.touches[0].clientX:e.clientX); sy=(e.touches?e.touches[0].clientY:e.clientY); card.style.transition="none";};
  const move=e=>{ if(!drag)return; x=(e.touches?e.touches[0].clientX:e.clientX)-sx; y=(e.touches?e.touches[0].clientY:e.clientY)-sy; const rot=clamp(x/12,-20,20); card.style.transform=`translateX(calc(-50% + ${x}px)) translateY(${y}px) rotate(${rot}deg)`; };
  const up=()=>{ if(!drag)return; drag=false; const th=120; if(x>th){ likeFlow(topId()); fly(card,1); } else if(x<-th){ passFlow(topId()); fly(card,-1); } else if(y<-th){ superFlow(topId()); fly(card,0); } else { card.style.transition="all .2s"; card.style.transform="translateX(-50%) rotate(0deg)"; } };
  card.addEventListener("mousedown",down); card.addEventListener("mousemove",move); document.addEventListener("mouseup",up);
  card.addEventListener("touchstart",down,{passive:true}); card.addEventListener("touchmove",move,{passive:true}); card.addEventListener("touchend",up);
}
function fly(card,dir){ card.style.transition="all .25s ease-out"; const x=dir===1?500:dir===-1?-500:0, y=dir===0?-500:50; card.style.transform=`translateX(${x}px) translateY(${y}px) rotate(${dir*25}deg)`; setTimeout(removeTop,220); }
document.addEventListener("keydown",(e)=>{ if(e.key==="ArrowLeft") passFlow(topId()); if(e.key==="ArrowRight") likeFlow(topId()); if(e.key==="ArrowUp") superFlow(topId()); });
document.getElementById("btnPass").onclick=()=>passFlow(topId());
document.getElementById("btnLike").onclick=()=>likeFlow(topId());
document.getElementById("btnSuper").onclick=()=>superFlow(topId());
document.getElementById("btnOpen").onclick=()=>openProfile(topId());

async function swipeLike(targetId){
  await sb.from('swipes').insert({ swiper: ME.id, swiped: targetId, action:'like' });
  const { data: m } = await sb
    .from('matches')
    .select('id')
    .or(`and(user_a.eq.${ME.id},user_b.eq.${targetId}),and(user_a.eq.${targetId},user_b.eq.${ME.id})`)
    .limit(1).maybeSingle();
  if(m){ alert("üéâ It's a match! Open Messages."); await renderMatches(); }
}
async function swipePass(targetId){
  await sb.from('swipes').insert({ swiper: ME.id, swiped: targetId, action:'pass' });
}
async function likeFlow(id){ if(!ME) return alert("Sign in first."); if(!id) return; await swipeLike(id); removeTop(); }
async function passFlow(id){ if(!ME) return; if(!id) return; await swipePass(id); removeTop(); }
async function superFlow(id){ if(!ME) return alert("Sign in first."); if(!id) return; await swipeLike(id); alert("‚≠ê Superlike sent!"); removeTop(); }

/* View profile modal */
function openProfile(id){
  if(!id) return; const p=getP(id); if(!p) return;
  document.getElementById("pmName").textContent=`${p.name}, ${p.age}`;
  document.getElementById("pmMeta").textContent=`${p.city} ‚Ä¢ ${p.pronouns||""} ‚Ä¢ ${p.goals} ‚Ä¢ ${p.distance} mi`;
  document.getElementById("pmInterests").innerHTML=(p.interests||[]).map(i=>`<span class="chip">${i}</span>`).join("");
  document.getElementById("pmBio").textContent=p.bio||"";
  const gal=document.getElementById("pmGallery"); gal.innerHTML="";
  (p.photos&&p.photos.length?p.photos:[avatarPNG(p.name)]).forEach(src=>{ const img=document.createElement("img"); img.src=src; img.className="rounded-xl border"; img.alt=p.name; gal.appendChild(img); });
  document.getElementById("pmLike").onclick=()=>{ likeFlow(p.id); closeModal(); };
  document.getElementById("pmSuper").onclick=()=>{ superFlow(p.id); closeModal(); };
  document.getElementById("pmMsg").onclick=()=>{ alert("Message after matching. Like each other to open chat."); closeModal(); };
  document.getElementById("pmReport").onclick=()=>{ alert("Reported. (Add admin review later.)"); closeModal(); };
  document.getElementById("pmBlock").onclick=()=>{ DECK=DECK.filter(x=>x.id!==p.id); renderGrid(); renderStack(); closeModal(); };
  document.getElementById("profileModal").classList.remove("hide");
}
function closeModal(){ document.getElementById("profileModal").classList.add("hide"); }
document.getElementById("pmClose").onclick=closeModal;

/* Matches & chat */
async function myMatches(){
  const { data } = await sb
    .from('matches')
    .select('id, user_a, user_b, created_at')
    .or(`user_a.eq.${ME.id},user_b.eq.${ME.id}`)
    .order('created_at',{ascending:false});
  return data || [];
}
async function renderMatches(){
  if(!ME){ document.getElementById("matchList").innerHTML="Sign in to see matches."; return; }
  const box=document.getElementById("matchList"); box.innerHTML="";
  const list = await myMatches();
  if(!list.length){ box.innerHTML=`<div class="small">No matches yet. Like people to match.</div>`; return; }
  for(const m of list){
    const otherId = (m.user_a===ME.id)? m.user_b : m.user_a;
    const { data: p } = await sb.from('profiles').select('id, display_name, city, photos').eq('id', otherId).maybeSingle();
    const name = p?.display_name || "Someone";
    const city = p?.city || "";
    const photo = (p?.photos && p.photos[0]) || avatarPNG(name);
    const row=document.createElement("div"); row.className="flex items-center gap-3 p-2 border-b border-slate-200";
    row.innerHTML=`<img src="${photo}" class="w-14 h-14 rounded-full object-cover border" alt="${name}"/><div class="flex-1"><div class="font-semibold text-lg">${name}</div><div class="small">${city}</div></div><button class="btn btn-ghost" data-chat="${m.id}">Open chat</button>`;
    box.appendChild(row);
  }
  box.querySelectorAll("[data-chat]").forEach(b=>b.onclick=()=>openChat(b.getAttribute("data-chat")));
}
async function loadMessages(matchId){
  const { data } = await sb.from('messages').select('id, sender, text, created_at').eq('match_id', matchId).order('created_at',{ascending:true});
  return data||[];
}
async function openChatRealtime(matchId, onNew){
  if(MSG_SUB){ await sb.removeChannel(MSG_SUB); MSG_SUB=null; }
  MSG_SUB = sb.channel(`messages:${matchId}`)
    .on('postgres_changes',{ event:'INSERT', schema:'public', table:'messages', filter:`match_id=eq.${matchId}` }, (payload)=> onNew(payload.new))
    .subscribe();
}
async function openChat(matchId){
  activeChatId = Number(matchId);
  const { data: m } = await sb.from('matches').select('id, user_a, user_b').eq('id', activeChatId).single();
  const otherId = (m.user_a===ME.id)? m.user_b : m.user_a;
  const { data: p } = await sb.from('profiles').select('display_name').eq('id', otherId).maybeSingle();
  document.getElementById("chatHeader").textContent = `Chatting with ${p?.display_name || "Someone"}`;
  const msgs = await loadMessages(activeChatId);
  const box=document.getElementById("chatBox"); box.innerHTML="";
  msgs.forEach(renderMsg);
  box.scrollTop = box.scrollHeight;
  await openChatRealtime(activeChatId, (msg)=>{ renderMsg(msg); box.scrollTop=box.scrollHeight; });
}
function renderMsg(msg){
  const box=document.getElementById("chatBox");
  const mine = (msg.sender===ME?.id);
  const d=document.createElement("div");
  d.className=`mb-2 flex ${mine?'justify-end':''}`;
  d.innerHTML=`<div class="max-w-[70%] ${mine?'bg-purple-600 text-white':'bg-slate-100'} px-3 py-2 rounded-xl">${escapeHTML(msg.text)}</div>`;
  box.appendChild(d);
}
document.getElementById("sendMsg").onclick = async ()=>{
  if(!activeChatId) return alert("Open a chat first.");
  if(!ME) return alert("Sign in first.");
  const t=document.getElementById("chatInput").value.trim(); if(!t) return;
  document.getElementById("chatInput").value="";
  await sb.from('messages').insert({ match_id: activeChatId, sender: ME.id, text: t });
};

/* ====== Bootstrap ====== */
function renderStatesChecks(containerId){
  const el = document.getElementById(containerId);
  el.innerHTML="";
  US_STATES.slice(1).forEach(st=>{
    const w=document.createElement("label");
    w.className="flex items-center gap-2 text-sm";
    w.innerHTML=`<input type="checkbox" class="state-check" value="${st}"/> ${st}`;
    el.appendChild(w);
  });
}
async function bootstrap(){
  fillStatePicker();
  renderStatesChecks("buyStatesWrap");
  await refreshAuthUI();
  if(ME){ MY_PROFILE = await loadMyProfile(); fillProfileForm(); }
  await reloadDeck();
  await renderAds();
  await loadAdmin();
}
bootstrap();
</script>
</body>
</html>
